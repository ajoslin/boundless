"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();Object.defineProperty(exports,"__esModule",{value:!0});var _react=require("react"),_react2=_interopRequireDefault(_react),_UIView2=require("../UIView"),_UIView3=_interopRequireDefault(_UIView2),_row=require("./row"),_row2=_interopRequireDefault(_row),_transform=require("../UIUtils/transform"),_transform2=_interopRequireDefault(_transform),_noop=require("../UIUtils/noop"),_noop2=_interopRequireDefault(_noop),cache_findWhereIndex=null,findWhere=function(e,t,i){for(cache_findWhereIndex=e.length-1;cache_findWhereIndex>-1;){if(e[cache_findWhereIndex][t]===i)return e[cache_findWhereIndex];cache_findWhereIndex-=1}},UITable=function(e){function t(){var e;_classCallCheck(this,t);for(var i=arguments.length,a=Array(i),n=0;i>n;n++)a[n]=arguments[n];var s=_possibleConstructorReturn(this,(e=Object.getPrototypeOf(t)).call.apply(e,[this].concat(a)));return s.handleRowClick=s.handleRowClick.bind(s),s.handleKeyDown=s.handleKeyDown.bind(s),s.handleDragMove=s.handleDragMove.bind(s),s.handleDragEnd=s.handleDragEnd.bind(s),s.handleMoveIntent=s.handleMoveIntent.bind(s),s.handleXScrollerDragStart=s.handleXScrollerDragStart.bind(s),s.handleYScrollerDragStart=s.handleYScrollerDragStart.bind(s),s.handleColumnDragStart=s.handleColumnDragStart.bind(s),s}return _inherits(t,e),_createClass(t,[{key:"initialState",value:function(){return{ariaSpokenOutput:"",chokeRender:!0,currentActiveRowIndex:-1,rows:[{data:this.props.getRow(0),setIndex:0,y:0}],rowsOrderedByY:[0],columns:this.props.columns.slice(0),xScrollerNubSize:null,yScrollerNubSize:null}}},{key:"componentDidMount",value:function(){this.xCurrent=this.yCurrent=0,this.xNext=this.yNext=null,this.yScrollNubPosition=0,this.cache_iterator=null,this.cache_nextActiveRow=null,this.cache_nRowsToShift=null,this.cache_orderedYArrayTargetIndex=null,this.cache_rowPointer=null,this.cache_shiftDelta=null,this.cache_targetIndex=null,this.cache_calculateXScrollerNubSize=null,this.cache_calculateYScrollerNubSize=null,this.cache_componentDidUpdate_node=null,this.cache_componentDidUpdate_nodeStyle=null,this.cache_captureDimensions_firstRow=null,this.cache_captureDimensions_firstRowCells=null,this.cache_captureDimensions_container=null,this.cache_captureDimensions_tableWidth=null,this.cache_captureDimensions_generatedRows=null,this.cache_captureDimensions_rowsOrderedByY=null,this.cache_ariaExposeFullRowData=null,this.captureDimensions()}},{key:"shouldComponentUpdate",value:function(){return!0}},{key:"componentDidUpdate",value:function(){this.refs.head&&void 0!==this.minimumColumnWidth&&(this.cache_componentDidUpdate_node=this.refs.wrapper.getElementsByClassName("ui-table-header-cell")[0],this.cache_componentDidUpdate_node&&(this.cache_componentDidUpdate_nodeStyle=window.getComputedStyle(this.cache_componentDidUpdate_node),this.maximumColumnWidth=parseInt(this.cache_componentDidUpdate_nodeStyle.maxWidth,10),this.minimumColumnWidth=parseInt(this.cache_componentDidUpdate_nodeStyle.minWidth,10)))}},{key:"calculateXScrollerNubSize",value:function(){return this.cache_calculateXScrollerNubSize=this.containerWidth-Math.abs(this.xMaximumTranslation),this.cache_calculateXScrollerNubSize<12?12:this.cache_calculateXScrollerNubSize}},{key:"calculateYScrollerNubSize",value:function(){return this.cache_calculateYScrollerNubSize=this.containerHeight*(this.nRowsToRender/this.props.totalRows),this.cache_calculateYScrollerNubSize<12?12:this.cache_calculateYScrollerNubSize}},{key:"captureDimensions",value:function(){for(this.cache_captureDimensions_firstRow=this.refs.body.getElementsByClassName("ui-table-row")[0],this.cache_captureDimensions_firstRowCells=this.cache_captureDimensions_firstRow.getElementsByClassName("ui-table-cell"),this.cache_captureDimensions_container=this.refs.wrapper,this.cellHeight=this.cache_captureDimensions_firstRowCells[0].clientHeight||40,this.containerHeight=this.cache_captureDimensions_container.clientHeight||150,this.containerWidth=this.cache_captureDimensions_container.clientWidth||500,this.nRowsToRender=Math.ceil(1.3*this.containerHeight/this.cellHeight),this.rowStartIndex=0,this.rowEndIndex=this.nRowsToRender,this.cache_captureDimensions_tableWidth=this.cache_captureDimensions_firstRow.clientWidth||500,this.xMaximumTranslation=this.containerWidth>this.cache_captureDimensions_tableWidth?0:this.containerWidth-this.cache_captureDimensions_tableWidth,this.yUpperBound=0,this.yLowerBound=this.containerHeight-this.nRowsToRender*this.cellHeight,this.cache_captureDimensions_generatedRows=[],this.cache_captureDimensions_rowsOrderedByY=[],this.cache_iterator=0;this.cache_iterator<this.nRowsToRender;this.cache_iterator+=1)this.cache_captureDimensions_generatedRows.push({data:this.props.getRow(this.cache_iterator),setIndex:this.cache_iterator,y:this.cellHeight*this.cache_iterator}),this.cache_captureDimensions_rowsOrderedByY.push(this.cache_iterator);this.setState({chokeRender:!1,columns:this.state.columns.map(function(e,t){return _extends({},e,{width:Math.ceil(this.cache_captureDimensions_firstRowCells[t].getBoundingClientRect().width)})},this),rows:this.cache_captureDimensions_generatedRows,rowsOrderedByY:this.cache_captureDimensions_rowsOrderedByY,xScrollerNubSize:this.calculateXScrollerNubSize(),yScrollerNubSize:this.calculateYScrollerNubSize()})}},{key:"handleScrollDown",value:function(){if(!(this.rowEndIndex===this.props.totalRows||this.yNext>=this.yLowerBound)&&(this.cache_nRowsToShift=Math.ceil(Math.abs(this.yNext-this.yLowerBound)/this.cellHeight),this.cache_nRowsToShift+this.rowEndIndex>this.props.totalRows&&(this.cache_nRowsToShift=this.props.totalRows-this.rowEndIndex),this.cache_nRowsToShift>0&&(this.cache_nRowsToShift>this.nRowsToRender&&(this.cache_shiftDelta=this.cache_nRowsToShift-this.nRowsToRender,this.yUpperBound-=this.cache_shiftDelta*this.cellHeight,this.yLowerBound-=this.cache_shiftDelta*this.cellHeight,this.rowStartIndex+=this.cache_shiftDelta,this.rowEndIndex+=this.cache_shiftDelta,this.cache_nRowsToShift=this.nRowsToRender),this.cache_nRowsToShift>0))){for(this.cache_orderedYArrayTargetIndex=0,this.cache_iterator=0;this.cache_iterator<this.cache_nRowsToShift;this.cache_iterator++)this.cache_targetIndex=this.rowEndIndex+this.cache_iterator,this.cache_rowPointer=this.state.rows[this.state.rowsOrderedByY[this.cache_orderedYArrayTargetIndex]],this.cache_rowPointer.data=this.props.getRow(this.cache_targetIndex),this.cache_rowPointer.setIndex=this.cache_targetIndex,this.cache_rowPointer.y=this.cache_targetIndex*this.cellHeight,this.state.rowsOrderedByY.push(this.state.rowsOrderedByY.shift());this.rowStartIndex+=this.cache_nRowsToShift,this.rowEndIndex+=this.cache_nRowsToShift,this.yUpperBound-=this.cache_nRowsToShift*this.cellHeight,this.yLowerBound-=this.cache_nRowsToShift*this.cellHeight,this.setState({rows:this.state.rows})}}},{key:"handleScrollUp",value:function(){if(!(0===this.rowStartIndex||this.yNext<=this.yUpperBound)&&(this.cache_nRowsToShift=Math.ceil(Math.abs(this.yNext-this.yUpperBound)/this.cellHeight),this.rowStartIndex-this.cache_nRowsToShift<0&&(this.cache_nRowsToShift=this.rowStartIndex),this.cache_nRowsToShift>0&&(this.cache_nRowsToShift>this.nRowsToRender&&(this.cache_shiftDelta=this.cache_nRowsToShift-this.nRowsToRender,this.yUpperBound+=this.cache_shiftDelta*this.cellHeight,this.yLowerBound+=this.cache_shiftDelta*this.cellHeight,this.rowStartIndex-=this.cache_shiftDelta,this.rowEndIndex-=this.cache_shiftDelta,this.cache_nRowsToShift=this.nRowsToRender),this.cache_nRowsToShift>0))){for(this.cache_orderedYArrayTargetIndex=this.state.rowsOrderedByY.length-1,this.cache_iterator=0;this.cache_iterator<this.cache_nRowsToShift;this.cache_iterator++)this.cache_targetIndex=this.rowStartIndex-this.cache_iterator-1,this.cache_rowPointer=this.state.rows[this.state.rowsOrderedByY[this.cache_orderedYArrayTargetIndex]],this.cache_rowPointer.data=this.props.getRow(this.cache_targetIndex),this.cache_rowPointer.setIndex=this.cache_targetIndex,this.cache_rowPointer.y=this.cache_targetIndex*this.cellHeight,this.state.rowsOrderedByY.unshift(this.state.rowsOrderedByY.pop());this.rowStartIndex-=this.cache_nRowsToShift,this.rowEndIndex-=this.cache_nRowsToShift,this.yUpperBound+=this.cache_nRowsToShift*this.cellHeight,this.yLowerBound+=this.cache_nRowsToShift*this.cellHeight,this.setState({rows:this.state.rows})}}},{key:"handleMoveIntent",value:function(e){e.preventDefault(),0===e.deltaX&&0===e.deltaY||this.manuallyScrollingY&&0===e.deltaY||this.manuallyScrollingX&&0===e.deltaX||(this.xNext=this.manuallyScrollingY?0:this.xCurrent-e.deltaX,this.xNext>0?this.xNext=0:this.xNext<this.xMaximumTranslation&&(this.xNext=this.xMaximumTranslation),this.yNext=this.manuallyScrollingX?0:this.yCurrent-e.deltaY,this.yNext<this.yCurrent?this.handleScrollDown():this.yNext>this.yCurrent&&this.handleScrollUp(),this.yNext>0?this.yNext=0:this.yNext<this.yLowerBound&&(this.yNext=this.yLowerBound),this.xNext!==this.xCurrent&&(this.refs.head.style[_transform2.default]="translate3d("+this.xNext+"px, 0px, 0px)"),this.refs.body.style[_transform2.default]="translate3d("+this.xNext+"px, "+this.yNext+"px, 0px)",this.refs.xScrollerNub.style[_transform2.default]="translate3d("+Math.abs(this.xNext)+"px, 0px, 0px)",this.yScrollNubPosition=this.rowStartIndex/this.props.totalRows*this.containerHeight,this.yScrollNubPosition+this.state.yScrollerNubSize>this.containerHeight&&(this.yScrollNubPosition=this.containerHeight-this.state.yScrollerNubSize),this.refs.yScrollerNub.style[_transform2.default]="translate3d(0px, "+this.yScrollNubPosition+"px, 0px)",this.xCurrent=this.xNext,this.yCurrent=this.yNext)}},{key:"handleColumnResize",value:function(e){var t=this;if(0!==e){var i=e,a=0,n=this.state.columns.map(function(e){return e.mapping!==t.manuallyResizingColumn.mapping?(a+=e.width,e):(0>i&&!isNaN(t.minimumColumnWidth)&&e.width+i<t.minimumColumnWidth?i=t.minimumColumnWidth-e.width:!isNaN(t.maximumColumnWidth)&&e.width+i>t.maximumColumnWidth&&(i=t.maximumColumnWidth-e.width),a+=e.width+i,_extends({},e,{width:e.width+i}))});a<=this.containerWidth?this.xMaximumTranslation=0:this.xMaximumTranslation-=i,this.setState({columns:n,xScrollerNubSize:this.calculateXScrollerNubSize()},function(){0>i&&t.handleMoveIntent({deltaX:i,deltaY:0,preventDefault:_noop2.default})})}}},{key:"handleColumnDragStart",value:function(e){0===e.button&&(this.lastColumnX=e.clientX,this.manuallyResizingColumn=this.state.columns[e.target.getAttribute("data-column-index")],e.nativeEvent.preventDefault())}},{key:"handleXScrollerDragStart",value:function(e){0===e.button&&(this.lastXScroll=e.clientX,this.manuallyScrollingX=!0,e.nativeEvent.preventDefault())}},{key:"handleYScrollerDragStart",value:function(e){0===e.button&&(this.lastYScroll=e.clientY,this.manuallyScrollingY=!0,e.nativeEvent.preventDefault())}},{key:"handleDragMove",value:function(e){0===e.button&&(this.manuallyResizingColumn&&(this.handleColumnResize(e.clientX-this.lastColumnX),this.lastColumnX=e.clientX),this.manuallyScrollingX&&(this.handleMoveIntent({deltaX:e.clientX-this.lastXScroll,deltaY:0,preventDefault:_noop2.default}),this.lastXScroll=e.clientX),this.manuallyScrollingY&&(this.handleMoveIntent({deltaX:0,deltaY:(e.clientY-this.lastYScroll)/this.containerHeight*this.props.totalRows*this.cellHeight,preventDefault:_noop2.default}),this.lastYScroll=e.clientY))}},{key:"handleDragEnd",value:function(){this.manuallyResizingColumn&&(this.manuallyResizingColumn=null),this.manuallyScrollingX&&(this.manuallyScrollingX=!1),this.manuallyScrollingY&&(this.manuallyScrollingY=!1)}},{key:"handleRowClick",value:function(e,t){this.props.onRowInteract&&(e.persist(),this.props.onRowInteract(e,t)),this.setState({currentActiveRowIndex:findWhere(this.state.rows,"data",t).setIndex})}},{key:"renderRows",value:function(){var e=this;return this.state.rows.map(function(t,i){return _react2.default.createElement(_row2.default,{key:i,active:t.setIndex===e.state.currentActiveRowIndex,columns:e.state.columns,data:t.data,even:t.setIndex%2===0,y:t.y,onInteract:e.handleRowClick,onCellInteract:e.props.onCellInteract})})}},{key:"renderBody",value:function(){return _react2.default.createElement("div",{ref:"body",className:"ui-table-body"},this.renderRows())}},{key:"renderColumnResizeHandle",value:function(e,t){return e.resizable?_react2.default.createElement("div",{className:"ui-table-header-cell-resize-handle","data-column-index":t,onMouseDown:this.handleColumnDragStart}):void 0}},{key:"renderHead",value:function(){var e=this;return this.state.chokeRender?void 0:_react2.default.createElement("div",{ref:"head",className:"ui-table-header"},_react2.default.createElement("div",{className:"ui-table-row ui-table-header-row"},this.state.columns.map(function(t,i){return _react2.default.createElement("div",{key:i,className:"ui-table-cell ui-table-header-cell",style:{width:"number"==typeof t.width?t.width:null}},_react2.default.createElement("div",{className:"ui-table-cell-inner"},_react2.default.createElement("span",{className:"ui-table-cell-inner-text"},t.title)),e.renderColumnResizeHandle(t,i))})))}},{key:"renderScrollbars",value:function(){return _react2.default.createElement("div",null,_react2.default.createElement("div",{className:"ui-table-x-scroller",onMouseDown:this.handleXScrollerDragStart},_react2.default.createElement("div",{ref:"xScrollerNub",className:"ui-table-x-scroller-nub",style:{width:this.state.xScrollerNubSize}})),_react2.default.createElement("div",{className:"ui-table-y-scroller",onMouseDown:this.handleYScrollerDragStart},_react2.default.createElement("div",{ref:"yScrollerNub",className:"ui-table-y-scroller-nub",style:{height:this.state.yScrollerNubSize}})))}},{key:"changeActiveRow",value:function(e){var t=this;this.cache_nextActiveRow=findWhere(this.state.rows,"setIndex",this.state.currentActiveRowIndex+e),this.cache_nextActiveRow?(this.setState({ariaSpokenOutput:this.cache_nextActiveRow.data[this.state.columns[0].mapping],currentActiveRowIndex:this.cache_nextActiveRow.setIndex}),(-1===e&&-1*this.cache_nextActiveRow.y>this.yCurrent||1===e&&-1*this.cache_nextActiveRow.y-this.cellHeight<this.yCurrent-this.containerHeight+this.cellHeight)&&this.handleMoveIntent({deltaX:0,deltaY:this.cellHeight*e,preventDefault:_noop2.default})):(-1===e&&this.state.currentActiveRowIndex>0||1===e&&this.state.currentActiveRowIndex<this.props.totalRows)&&(this.handleMoveIntent({deltaX:0,deltaY:(this.rowStartIndex>this.state.currentActiveRowIndex&&this.state.currentActiveRowIndex-this.rowStartIndex||(this.rowStartIndex<this.state.currentActiveRowIndex&&this.state.currentActiveRowIndex-this.rowStartIndex)+e)*this.cellHeight,preventDefault:_noop2.default}),window.requestAnimationFrame(function(){return t.changeActiveRow(e)})),this.cache_nextActiveRow=null}},{key:"ariaExposeFullRowData",value:function(){var e=this;this.cache_ariaExposeFullRowData=findWhere(this.state.rows,"setIndex",this.state.currentActiveRowIndex),this.cache_ariaExposeFullRowData&&this.setState({ariaSpokenOutput:this.state.columns.map(function(t){return t.title+": "+e.cache_ariaExposeFullRowData.data[t.mapping]}).join("\n")})}},{key:"handleKeyDown",value:function(e){switch(e.key){case"ArrowDown":this.changeActiveRow(1),e.preventDefault();break;case"ArrowUp":this.changeActiveRow(-1),e.preventDefault();break;case"Enter":this.ariaExposeFullRowData(),e.preventDefault()}"function"==typeof this.props.onKeyDown&&(e.persist(),this.props.onKeyDown(e))}},{key:"renderNotification",value:function(){return _react2.default.createElement("div",{ref:"aria",className:this.props.offscreenClass,"aria-live":"polite"},this.state.ariaSpokenOutput)}},{key:"render",value:function(){return _react2.default.createElement("div",_extends({},this.props,{ref:"wrapper",className:"ui-table-wrapper "+this.props.className,onKeyDown:this.handleKeyDown,onMouseMove:this.handleDragMove,onMouseUp:this.handleDragEnd,onWheel:this.handleMoveIntent,tabIndex:"0"}),_react2.default.createElement("div",{ref:"table",className:"ui-table"},this.renderHead(),this.renderBody()),this.renderNotification(),this.renderScrollbars())}}]),t}(_UIView3.default);UITable.propTypes={columns:_react2.default.PropTypes.arrayOf(_react2.default.PropTypes.shape({mapping:_react2.default.PropTypes.string,resizable:_react2.default.PropTypes.bool,title:_react2.default.PropTypes.string,width:_react2.default.PropTypes.number})),getRow:_react2.default.PropTypes.func,offscreenClass:_react2.default.PropTypes.string,onCellInteract:_react2.default.PropTypes.func,onRowInteract:_react2.default.PropTypes.func,totalRows:_react2.default.PropTypes.number},UITable.defaultProps={className:"",columns:[],getRow:_noop2.default,offscreenClass:"ui-offscreen",totalRows:0},exports.default=UITable;