"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();Object.defineProperty(exports,"__esModule",{value:!0});var _react=require("react"),_react2=_interopRequireDefault(_react),_UIView2=require("../UIView"),_UIView3=_interopRequireDefault(_UIView2),_row=require("./row"),_row2=_interopRequireDefault(_row),_transform=require("../UIUtils/transform"),_transform2=_interopRequireDefault(_transform),_noop=require("../UIUtils/noop"),_noop2=_interopRequireDefault(_noop),_findWhereIndex=null,findWhere=function(array,property,value){for(_findWhereIndex=array.length-1;_findWhereIndex>-1;){if(array[_findWhereIndex][property]===value)return array[_findWhereIndex];_findWhereIndex-=1}},UITable=function(_UIView){function UITable(){var _Object$getPrototypeO;_classCallCheck(this,UITable);for(var _len=arguments.length,args=Array(_len),_key=0;_len>_key;_key++)args[_key]=arguments[_key];var _this=_possibleConstructorReturn(this,(_Object$getPrototypeO=Object.getPrototypeOf(UITable)).call.apply(_Object$getPrototypeO,[this].concat(args)));return _this.captureConstraints=_this.captureConstraints.bind(_this),_this.handleRowClick=_this.handleRowClick.bind(_this),_this.handleKeyDown=_this.handleKeyDown.bind(_this),_this.handleDragMove=_this.handleDragMove.bind(_this),_this.handleDragEnd=_this.handleDragEnd.bind(_this),_this.handleMoveIntent=_this.handleMoveIntent.bind(_this),_this.handleXScrollerDragStart=_this.handleXScrollerDragStart.bind(_this),_this.handleYScrollerDragStart=_this.handleYScrollerDragStart.bind(_this),_this.handleColumnDragStart=_this.handleColumnDragStart.bind(_this),_this}return _inherits(UITable,_UIView),_createClass(UITable,[{key:"initialState",value:function(){return{ariaSpokenOutput:"",chokeRender:!0,currentActiveRowIndex:-1,rows:[{data:this.props.getRow(0),setIndex:0,y:0}],rowsOrderedByY:[0],columns:this.props.columns.slice(0),xScrollerNubSize:null,yScrollerNubSize:null}}},{key:"componentDidMount",value:function(){this.captureConstraints(),window.addEventListener("resize",this.captureConstraints,!0)}},{key:"componentWillReceiveProps",value:function(){var _this2=this;this.setState(this.initialState(),function(){return _this2.captureConstraints()})}},{key:"shouldComponentUpdate",value:function(){return!0}},{key:"componentDidUpdate",value:function(){this.refs.head&&void 0!==this._minimumColumnWidth&&(this._componentDidUpdate_node=this.refs.wrapper.getElementsByClassName("ui-table-header-cell")[0],this._componentDidUpdate_node&&(this._componentDidUpdate_nodeStyle=window.getComputedStyle(this._componentDidUpdate_node),this._maximumColumnWidth=parseInt(this._componentDidUpdate_nodeStyle.maxWidth,10),this._minimumColumnWidth=parseInt(this._componentDidUpdate_nodeStyle.minWidth,10)))}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.captureConstraints,!0)}},{key:"calculateXScrollerNubSize",value:function(){return this._calculateXScrollerNubSize=this._containerWidth-Math.abs(this._xMaximumTranslation),this._calculateXScrollerNubSize<12?12:this._calculateXScrollerNubSize}},{key:"calculateYScrollerNubSize",value:function(){return this._calculateYScrollerNubSize=this._containerHeight*(this.nRowsToRender/this.props.totalRows),this._calculateYScrollerNubSize<12?12:this._calculateYScrollerNubSize}},{key:"resetInternalCaches",value:function(){this._xCurrent=this._yCurrent=0,this._xNext=this._yNext=0,this._xCurrentScrollNubPosition=this._xScrollNubPosition=0,this._yCurrentScrollNubPosition=this._yScrollNubPosition=0,this._iterator=null,this._nextActiveRow=null,this._nRowsToShift=null,this._orderedYArrayTargetIndex=null,this._rowPointer=null,this._shiftDelta=null,this._targetIndex=null,this._calculateXScrollerNubSize=null,this._calculateYScrollerNubSize=null,this._componentDidUpdate_node=null,this._componentDidUpdate_nodeStyle=null,this._captureConstraints_firstRow=null,this._captureConstraints_firstRowCells=null,this._captureConstraints_container=null,this._captureConstraints_generatedRows=null,this._captureConstraints_rowsOrderedByY=null,this._ariaExposeFullRowData=null,this.performTranslations()}},{key:"calculateXAxisConsiderations",value:function(){this._rowWidth=this.refs.body.getElementsByClassName("ui-table-row")[0].clientWidth||500,this._xMaximumTranslation=this._containerWidth>this._rowWidth?0:this._containerWidth-this._rowWidth}},{key:"captureConstraints",value:function(){for(this.resetInternalCaches(),this._captureConstraints_firstRow=this.refs.body.getElementsByClassName("ui-table-row")[0],this._captureConstraints_firstRowCells=this._captureConstraints_firstRow.getElementsByClassName("ui-table-cell"),this._captureConstraints_container=this.refs.wrapper,this._cellHeight=this._captureConstraints_firstRowCells[0].clientHeight||40,this._containerHeight=this._captureConstraints_container.clientHeight||150,this._containerWidth=this._captureConstraints_container.clientWidth||500,this._xScrollerWidth=this.refs.xScroller.clientWidth,this.nRowsToRender=Math.ceil(1.3*this._containerHeight/this._cellHeight),this.nRowsToRender>this.props.totalRows&&(this.nRowsToRender=this.props.totalRows),this._rowStartIndex=0,this._rowEndIndex=this.nRowsToRender,this.calculateXAxisConsiderations(),this._yUpperBound=0,this._yLowerBound=this._containerHeight-this.nRowsToRender*this._cellHeight,this._captureConstraints_generatedRows=[],this._captureConstraints_rowsOrderedByY=[],this._iterator=0;this._iterator<this.nRowsToRender;this._iterator+=1)this._captureConstraints_generatedRows.push({data:this.props.getRow(this._iterator),setIndex:this._iterator,y:this._cellHeight*this._iterator}),this._captureConstraints_rowsOrderedByY.push(this._iterator);this.setState({chokeRender:!1,columns:this.state.columns.map(function(column,index){return _extends({},column,{width:Math.ceil(this._captureConstraints_firstRowCells[index].getBoundingClientRect().width)})},this),rows:this._captureConstraints_generatedRows,rowsOrderedByY:this._captureConstraints_rowsOrderedByY,xScrollerNubSize:this.calculateXScrollerNubSize(),yScrollerNubSize:this.calculateYScrollerNubSize()})}},{key:"handleScrollDown",value:function(){if(!(this._rowEndIndex===this.props.totalRows||this._yNext>=this._yLowerBound)&&(this._nRowsToShift=Math.ceil(Math.abs(this._yNext-this._yLowerBound)/this._cellHeight),this._nRowsToShift+this._rowEndIndex+1>this.props.totalRows&&(this._nRowsToShift=this.props.totalRows-this._rowEndIndex+1),this._nRowsToShift>0&&(this._nRowsToShift>this.nRowsToRender&&(this._shiftDelta=this._nRowsToShift-this.nRowsToRender,this._yUpperBound-=this._shiftDelta*this._cellHeight,this._yLowerBound-=this._shiftDelta*this._cellHeight,this._rowStartIndex+=this._shiftDelta,this._rowEndIndex+=this._shiftDelta,this._nRowsToShift=this.nRowsToRender),this._nRowsToShift>0))){for(this._orderedYArrayTargetIndex=0,this._iterator=0;this._iterator<this._nRowsToShift;this._iterator++)this._targetIndex=this._rowEndIndex+this._iterator,this._rowPointer=this.state.rows[this.state.rowsOrderedByY[this._orderedYArrayTargetIndex]],this._rowPointer.data=this.props.getRow(this._targetIndex),this._rowPointer.setIndex=this._targetIndex,this._rowPointer.y=this._targetIndex*this._cellHeight,this.state.rowsOrderedByY.push(this.state.rowsOrderedByY.shift());this._rowStartIndex+=this._nRowsToShift,this._rowEndIndex+=this._nRowsToShift,this._yUpperBound-=this._nRowsToShift*this._cellHeight,this._yLowerBound-=this._nRowsToShift*this._cellHeight,this.setState({rows:this.state.rows})}}},{key:"handleScrollUp",value:function(){if(!(0===this._rowStartIndex||this._yNext<=this._yUpperBound)&&(this._nRowsToShift=Math.ceil(Math.abs(this._yNext-this._yUpperBound)/this._cellHeight),this._rowStartIndex-this._nRowsToShift<0&&(this._nRowsToShift=this._rowStartIndex),this._nRowsToShift>0&&(this._nRowsToShift>this.nRowsToRender&&(this._shiftDelta=this._nRowsToShift-this.nRowsToRender,this._yUpperBound+=this._shiftDelta*this._cellHeight,this._yLowerBound+=this._shiftDelta*this._cellHeight,this._rowStartIndex-=this._shiftDelta,this._rowEndIndex-=this._shiftDelta,this._nRowsToShift=this.nRowsToRender),this._nRowsToShift>0))){for(this._orderedYArrayTargetIndex=this.state.rowsOrderedByY.length-1,this._iterator=0;this._iterator<this._nRowsToShift;this._iterator++)this._targetIndex=this._rowStartIndex-this._iterator-1,this._rowPointer=this.state.rows[this.state.rowsOrderedByY[this._orderedYArrayTargetIndex]],this._rowPointer.data=this.props.getRow(this._targetIndex),this._rowPointer.setIndex=this._targetIndex,this._rowPointer.y=this._targetIndex*this._cellHeight,this.state.rowsOrderedByY.unshift(this.state.rowsOrderedByY.pop());this._rowStartIndex-=this._nRowsToShift,this._rowEndIndex-=this._nRowsToShift,this._yUpperBound+=this._nRowsToShift*this._cellHeight,this._yLowerBound+=this._nRowsToShift*this._cellHeight,this.setState({rows:this.state.rows})}}},{key:"performTranslations",value:function(){this.refs.head&&(this.refs.head.style[_transform2.default]="translate3d("+this._xNext+"px, 0px, 0px)"),this.refs.body.style[_transform2.default]="translate3d("+this._xNext+"px, "+this._yNext+"px, 0px)",this.refs.xScrollerNub.style[_transform2.default]="translate3d("+this._xScrollNubPosition+"px, 0px, 0px)",this.refs.yScrollerNub.style[_transform2.default]="translate3d(0px, "+this._yScrollNubPosition+"px, 0px)"}},{key:"handleMoveIntent",value:function(event){event.preventDefault(),0===event.deltaX&&0===event.deltaY||this._manuallyScrollingY&&0===event.deltaY||this._manuallyScrollingX&&0===event.deltaX||(this._xNext=this._manuallyScrollingY?0:this._xCurrent-event.deltaX,this._xNext>0?this._xNext=0:this._xNext<this._xMaximumTranslation&&(this._xNext=this._xMaximumTranslation),this._yNext=this._manuallyScrollingX?0:this._yCurrent-event.deltaY,this._yNext<this._yCurrent?this.handleScrollDown():this._yNext>this._yCurrent&&this.handleScrollUp(),this._yNext>0?this._yNext=0:this._yNext<this._yLowerBound&&(this._yNext=this._yLowerBound),this._xScrollNubPosition=Math.abs(this._xNext)/(this._rowWidth-this._containerWidth)*(this._xScrollerWidth-this.state.xScrollerNubSize),this._xScrollNubPosition+this.state.xScrollerNubSize>this._xScrollerWidth&&(this._xScrollNubPosition=this._xScrollerWidth-this.state.xScrollerNubSize),this._yScrollNubPosition=this._rowStartIndex/this.props.totalRows*this._containerHeight,this._yScrollNubPosition+this.state.yScrollerNubSize>this._containerHeight&&(this._yScrollNubPosition=this._containerHeight-this.state.yScrollerNubSize),this.performTranslations(),this._xCurrent=this._xNext,this._yCurrent=this._yNext,this._xCurrentScrollNubPosition=this._xScrollNubPosition,this._yCurrentScrollNubPosition=this._yScrollNubPosition)}},{key:"handleColumnResize",value:function(delta){var _this3=this;if(0!==delta){var adjustedDelta=delta,newTableWidth=0,copy=this.state.columns.map(function(definition){return definition.mapping!==_this3._manuallyResizingColumn.mapping?(newTableWidth+=definition.width,definition):(0>adjustedDelta&&!isNaN(_this3._minimumColumnWidth)&&definition.width+adjustedDelta<_this3._minimumColumnWidth?adjustedDelta=_this3._minimumColumnWidth-definition.width:!isNaN(_this3._maximumColumnWidth)&&definition.width+adjustedDelta>_this3._maximumColumnWidth&&(adjustedDelta=_this3._maximumColumnWidth-definition.width),newTableWidth+=definition.width+adjustedDelta,_extends({},definition,{width:definition.width+adjustedDelta}))});newTableWidth<=this._containerWidth?this._xMaximumTranslation=0:this._xMaximumTranslation-=adjustedDelta,this.setState({columns:copy,xScrollerNubSize:this.calculateXScrollerNubSize()},function(){_this3.calculateXAxisConsiderations(),0>adjustedDelta&&_this3.handleMoveIntent({deltaX:adjustedDelta,deltaY:0,preventDefault:_noop2.default})})}}},{key:"handleColumnDragStart",value:function(event){0===event.button&&(this._lastColumnX=event.clientX,this._manuallyResizingColumn=this.state.columns[event.target.getAttribute("data-column-index")],window.addEventListener("mouseup",this.handleDragEnd,!0),event.nativeEvent.preventDefault())}},{key:"handleXScrollerDragStart",value:function(event){0===event.button&&(this._lastXScroll=event.clientX,this._manuallyScrollingX=!0,window.addEventListener("mouseup",this.handleDragEnd,!0),event.nativeEvent.preventDefault())}},{key:"handleYScrollerDragStart",value:function(event){0===event.button&&(this._lastYScroll=event.clientY,this._manuallyScrollingY=!0,window.addEventListener("mouseup",this.handleDragEnd,!0),event.nativeEvent.preventDefault())}},{key:"handleDragMove",value:function(event){0===event.button&&(this._manuallyResizingColumn&&(this.handleColumnResize(event.clientX-this._lastColumnX),this._lastColumnX=event.clientX),this._manuallyScrollingX&&(this.handleMoveIntent({deltaX:event.clientX-this._lastXScroll,deltaY:0,preventDefault:_noop2.default}),this._lastXScroll=event.clientX),this._manuallyScrollingY&&(this.handleMoveIntent({deltaX:0,deltaY:(event.clientY-this._lastYScroll)/this._containerHeight*this.props.totalRows*this._cellHeight,preventDefault:_noop2.default}),this._lastYScroll=event.clientY))}},{key:"handleDragEnd",value:function(){window.removeEventListener("mouseup",this.handleDragEnd,!0),this._manuallyScrollingX=this._manuallyScrollingY=this._manuallyResizingColumn=!1}},{key:"handleRowClick",value:function(event,clickedRowData){this.props.onRowInteract&&(event.persist(),this.props.onRowInteract(event,clickedRowData)),this.setState({currentActiveRowIndex:findWhere(this.state.rows,"data",clickedRowData).setIndex})}},{key:"renderRows",value:function(){var _this4=this;return this.state.rows.map(function(row,index){return _react2.default.createElement(_row2.default,{key:index,active:row.setIndex===_this4.state.currentActiveRowIndex,columns:_this4.state.columns,data:row.data,even:row.setIndex%2===0,y:row.y,onInteract:_this4.handleRowClick,onCellInteract:_this4.props.onCellInteract})})}},{key:"renderBody",value:function(){return _react2.default.createElement("div",{ref:"body",className:"ui-table-body"},this.renderRows())}},{key:"renderColumnResizeHandle",value:function(column,index){return column.resizable?_react2.default.createElement("div",{className:"ui-table-header-cell-resize-handle","data-column-index":index,onMouseDown:this.handleColumnDragStart}):void 0}},{key:"renderHead",value:function(){var _this5=this;return this.state.chokeRender?void 0:_react2.default.createElement("div",{ref:"head",className:"ui-table-header"},_react2.default.createElement("div",{className:"ui-table-row ui-table-header-row"},this.state.columns.map(function(column,index){return _react2.default.createElement("div",{key:index,className:"ui-table-cell ui-table-header-cell",style:{width:"number"==typeof column.width?column.width:null}},_react2.default.createElement("div",{className:"ui-table-cell-inner"},_react2.default.createElement("span",{className:"ui-table-cell-inner-text"},column.title)),_this5.renderColumnResizeHandle(column,index))})))}},{key:"renderScrollbars",value:function(){return _react2.default.createElement("div",null,_react2.default.createElement("div",{ref:"xScroller",className:"ui-table-x-scroller",onMouseDown:this.handleXScrollerDragStart},_react2.default.createElement("div",{ref:"xScrollerNub",className:"ui-table-x-scroller-nub",style:{width:this.state.xScrollerNubSize}})),_react2.default.createElement("div",{className:"ui-table-y-scroller",onMouseDown:this.handleYScrollerDragStart},_react2.default.createElement("div",{ref:"yScrollerNub",className:"ui-table-y-scroller-nub",style:{height:this.state.yScrollerNubSize}})))}},{key:"changeActiveRow",value:function(delta){var _this6=this;this._nextActiveRow=findWhere(this.state.rows,"setIndex",this.state.currentActiveRowIndex+delta),this._nextActiveRow?(this.setState({ariaSpokenOutput:this._nextActiveRow.data[this.state.columns[0].mapping],currentActiveRowIndex:this._nextActiveRow.setIndex}),(-1===delta&&-1*this._nextActiveRow.y>this._yCurrent||1===delta&&-1*this._nextActiveRow.y-this._cellHeight<this._yCurrent-this._containerHeight+this._cellHeight)&&this.handleMoveIntent({deltaX:0,deltaY:this._cellHeight*delta,preventDefault:_noop2.default})):(-1===delta&&this.state.currentActiveRowIndex>0||1===delta&&this.state.currentActiveRowIndex<this.props.totalRows)&&(this.handleMoveIntent({deltaX:0,deltaY:(this._rowStartIndex>this.state.currentActiveRowIndex&&this.state.currentActiveRowIndex-this._rowStartIndex||(this._rowStartIndex<this.state.currentActiveRowIndex&&this.state.currentActiveRowIndex-this._rowStartIndex)+delta)*this._cellHeight,preventDefault:_noop2.default}),window.requestAnimationFrame(function(){return _this6.changeActiveRow(delta)})),this._nextActiveRow=null}},{key:"ariaExposeFullRowData",value:function(){var _this7=this;this._ariaExposeFullRowData=findWhere(this.state.rows,"setIndex",this.state.currentActiveRowIndex),this._ariaExposeFullRowData&&this.setState({ariaSpokenOutput:this.state.columns.map(function(column){return column.title+": "+_this7._ariaExposeFullRowData.data[column.mapping]}).join("\n")})}},{key:"handleKeyDown",value:function(event){switch(event.key){case"ArrowDown":this.changeActiveRow(1),event.preventDefault();break;case"ArrowUp":this.changeActiveRow(-1),event.preventDefault();break;case"Enter":this.ariaExposeFullRowData(),event.preventDefault()}"function"==typeof this.props.onKeyDown&&(event.persist(),this.props.onKeyDown(event))}},{key:"renderNotification",value:function(){return _react2.default.createElement("div",{ref:"aria",className:this.props.offscreenClass,"aria-live":"polite"},this.state.ariaSpokenOutput)}},{key:"render",value:function(){return _react2.default.createElement("div",_extends({},this.props,{ref:"wrapper",className:"ui-table-wrapper "+this.props.className,onKeyDown:this.handleKeyDown,onMouseMove:this.handleDragMove,onWheel:this.handleMoveIntent,tabIndex:"0"}),_react2.default.createElement("div",{ref:"table",className:"ui-table"},this.renderHead(),this.renderBody()),this.renderNotification(),this.renderScrollbars())}}]),UITable}(_UIView3.default);UITable.propTypes={columns:_react2.default.PropTypes.arrayOf(_react2.default.PropTypes.shape({mapping:_react2.default.PropTypes.string,resizable:_react2.default.PropTypes.bool,title:_react2.default.PropTypes.string,width:_react2.default.PropTypes.number})),getRow:_react2.default.PropTypes.func,offscreenClass:_react2.default.PropTypes.string,onCellInteract:_react2.default.PropTypes.func,onRowInteract:_react2.default.PropTypes.func,name:_react2.default.PropTypes.string,totalRows:_react2.default.PropTypes.number},UITable.defaultProps={className:"",columns:[],getRow:_noop2.default,offscreenClass:"ui-offscreen",totalRows:0},exports.default=UITable;