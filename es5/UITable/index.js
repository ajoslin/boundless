"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}();Object.defineProperty(exports,"__esModule",{value:!0});var _react=require("react"),_react2=_interopRequireDefault(_react),_UIView2=require("../UIView"),_UIView3=_interopRequireDefault(_UIView2),_row=require("./row"),_row2=_interopRequireDefault(_row),_transform=require("../UIUtils/transform"),_transform2=_interopRequireDefault(_transform),_noop=require("../UIUtils/noop"),_noop2=_interopRequireDefault(_noop),_findWhereIndex=null,findWhere=function(t,e,i){for(_findWhereIndex=t.length-1;_findWhereIndex>-1;){if(t[_findWhereIndex][e]===i)return t[_findWhereIndex];_findWhereIndex-=1}},UITable=function(t){function e(){var t;_classCallCheck(this,e);for(var i=arguments.length,r=Array(i),n=0;i>n;n++)r[n]=arguments[n];var s=_possibleConstructorReturn(this,(t=Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)));return s.captureConstraints=s.captureConstraints.bind(s),s.handleRowClick=s.handleRowClick.bind(s),s.handleKeyDown=s.handleKeyDown.bind(s),s.handleDragMove=s.handleDragMove.bind(s),s.handleDragEnd=s.handleDragEnd.bind(s),s.handleMoveIntent=s.handleMoveIntent.bind(s),s.handleXScrollerDragStart=s.handleXScrollerDragStart.bind(s),s.handleYScrollerDragStart=s.handleYScrollerDragStart.bind(s),s.handleColumnDragStart=s.handleColumnDragStart.bind(s),s}return _inherits(e,t),_createClass(e,[{key:"initialState",value:function(){return{ariaSpokenOutput:"",chokeRender:!0,currentActiveRowIndex:-1,rows:[{data:this.props.getRow(0),setIndex:0,y:0}],rowsOrderedByY:[0],columns:this.props.columns.slice(0),xScrollerNubSize:null,yScrollerNubSize:null}}},{key:"componentDidMount",value:function(){this.captureConstraints(),window.addEventListener("resize",this.captureConstraints,!0)}},{key:"componentWillReceiveProps",value:function(){var t=this;this.setState(this.initialState(),function(){return t.captureConstraints()})}},{key:"shouldComponentUpdate",value:function(){return!0}},{key:"componentDidUpdate",value:function(){this.refs.head&&void 0!==this._minimumColumnWidth&&(this._componentDidUpdate_node=this.refs.wrapper.getElementsByClassName("ui-table-header-cell")[0],this._componentDidUpdate_node&&(this._componentDidUpdate_nodeStyle=window.getComputedStyle(this._componentDidUpdate_node),this._maximumColumnWidth=parseInt(this._componentDidUpdate_nodeStyle.maxWidth,10),this._minimumColumnWidth=parseInt(this._componentDidUpdate_nodeStyle.minWidth,10)))}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.captureConstraints,!0)}},{key:"calculateXScrollerNubSize",value:function(){return this._calculateXScrollerNubSize=this._containerWidth-Math.abs(this._xMaximumTranslation),this._calculateXScrollerNubSize<12?12:this._calculateXScrollerNubSize}},{key:"calculateYScrollerNubSize",value:function(){return this._calculateYScrollerNubSize=this._containerHeight*(this.nRowsToRender/this.props.totalRows),this._calculateYScrollerNubSize<12?12:this._calculateYScrollerNubSize}},{key:"resetInternalCaches",value:function(){this._xCurrent=this._yCurrent=0,this._xNext=this._yNext=0,this._xCurrentScrollNubPosition=this._xScrollNubPosition=0,this._yCurrentScrollNubPosition=this._yScrollNubPosition=0,this._iterator=null,this._nextActiveRow=null,this._nRowsToShift=null,this._orderedYArrayTargetIndex=null,this._rowPointer=null,this._shiftDelta=null,this._targetIndex=null,this._calculateXScrollerNubSize=null,this._calculateYScrollerNubSize=null,this._componentDidUpdate_node=null,this._componentDidUpdate_nodeStyle=null,this._captureConstraints_firstRow=null,this._captureConstraints_firstRowCells=null,this._captureConstraints_container=null,this._captureConstraints_generatedRows=null,this._captureConstraints_rowsOrderedByY=null,this._ariaExposeFullRowData=null,this.performTranslations()}},{key:"captureConstraints",value:function(){for(this.resetInternalCaches(),this._captureConstraints_firstRow=this.refs.body.getElementsByClassName("ui-table-row")[0],this._captureConstraints_firstRowCells=this._captureConstraints_firstRow.getElementsByClassName("ui-table-cell"),this._captureConstraints_container=this.refs.wrapper,this._cellHeight=this._captureConstraints_firstRowCells[0].clientHeight||40,this._rowWidth=this._captureConstraints_firstRow.clientWidth||500,this._containerHeight=this._captureConstraints_container.clientHeight||150,this._containerWidth=this._captureConstraints_container.clientWidth||500,this._xScrollerWidth=this.refs.xScroller.clientWidth,this.nRowsToRender=Math.ceil(1.3*this._containerHeight/this._cellHeight),this.nRowsToRender>this.props.totalRows&&(this.nRowsToRender=this.props.totalRows),this._rowStartIndex=0,this._rowEndIndex=this.nRowsToRender,this._xMaximumTranslation=this._containerWidth>this._rowWidth?0:this._containerWidth-this._rowWidth,this._yUpperBound=0,this._yLowerBound=this._containerHeight-this.nRowsToRender*this._cellHeight,this._captureConstraints_generatedRows=[],this._captureConstraints_rowsOrderedByY=[],this._iterator=0;this._iterator<this.nRowsToRender;this._iterator+=1)this._captureConstraints_generatedRows.push({data:this.props.getRow(this._iterator),setIndex:this._iterator,y:this._cellHeight*this._iterator}),this._captureConstraints_rowsOrderedByY.push(this._iterator);this.setState({chokeRender:!1,columns:this.state.columns.map(function(t,e){return _extends({},t,{width:Math.ceil(this._captureConstraints_firstRowCells[e].getBoundingClientRect().width)})},this),rows:this._captureConstraints_generatedRows,rowsOrderedByY:this._captureConstraints_rowsOrderedByY,xScrollerNubSize:this.calculateXScrollerNubSize(),yScrollerNubSize:this.calculateYScrollerNubSize()})}},{key:"handleScrollDown",value:function(){if(!(this._rowEndIndex===this.props.totalRows||this._yNext>=this._yLowerBound)&&(this._nRowsToShift=Math.ceil(Math.abs(this._yNext-this._yLowerBound)/this._cellHeight),this._nRowsToShift+this._rowEndIndex+1>this.props.totalRows&&(this._nRowsToShift=this.props.totalRows-this._rowEndIndex+1),this._nRowsToShift>0&&(this._nRowsToShift>this.nRowsToRender&&(this._shiftDelta=this._nRowsToShift-this.nRowsToRender,this._yUpperBound-=this._shiftDelta*this._cellHeight,this._yLowerBound-=this._shiftDelta*this._cellHeight,this._rowStartIndex+=this._shiftDelta,this._rowEndIndex+=this._shiftDelta,this._nRowsToShift=this.nRowsToRender),this._nRowsToShift>0))){for(this._orderedYArrayTargetIndex=0,this._iterator=0;this._iterator<this._nRowsToShift;this._iterator++)this._targetIndex=this._rowEndIndex+this._iterator,this._rowPointer=this.state.rows[this.state.rowsOrderedByY[this._orderedYArrayTargetIndex]],this._rowPointer.data=this.props.getRow(this._targetIndex),this._rowPointer.setIndex=this._targetIndex,this._rowPointer.y=this._targetIndex*this._cellHeight,this.state.rowsOrderedByY.push(this.state.rowsOrderedByY.shift());this._rowStartIndex+=this._nRowsToShift,this._rowEndIndex+=this._nRowsToShift,this._yUpperBound-=this._nRowsToShift*this._cellHeight,this._yLowerBound-=this._nRowsToShift*this._cellHeight,this.setState({rows:this.state.rows})}}},{key:"handleScrollUp",value:function(){if(!(0===this._rowStartIndex||this._yNext<=this._yUpperBound)&&(this._nRowsToShift=Math.ceil(Math.abs(this._yNext-this._yUpperBound)/this._cellHeight),this._rowStartIndex-this._nRowsToShift<0&&(this._nRowsToShift=this._rowStartIndex),this._nRowsToShift>0&&(this._nRowsToShift>this.nRowsToRender&&(this._shiftDelta=this._nRowsToShift-this.nRowsToRender,this._yUpperBound+=this._shiftDelta*this._cellHeight,this._yLowerBound+=this._shiftDelta*this._cellHeight,this._rowStartIndex-=this._shiftDelta,this._rowEndIndex-=this._shiftDelta,this._nRowsToShift=this.nRowsToRender),this._nRowsToShift>0))){for(this._orderedYArrayTargetIndex=this.state.rowsOrderedByY.length-1,this._iterator=0;this._iterator<this._nRowsToShift;this._iterator++)this._targetIndex=this._rowStartIndex-this._iterator-1,this._rowPointer=this.state.rows[this.state.rowsOrderedByY[this._orderedYArrayTargetIndex]],this._rowPointer.data=this.props.getRow(this._targetIndex),this._rowPointer.setIndex=this._targetIndex,this._rowPointer.y=this._targetIndex*this._cellHeight,this.state.rowsOrderedByY.unshift(this.state.rowsOrderedByY.pop());this._rowStartIndex-=this._nRowsToShift,this._rowEndIndex-=this._nRowsToShift,this._yUpperBound+=this._nRowsToShift*this._cellHeight,this._yLowerBound+=this._nRowsToShift*this._cellHeight,this.setState({rows:this.state.rows})}}},{key:"performTranslations",value:function(){this.refs.head&&(this.refs.head.style[_transform2.default]="translate3d("+this._xNext+"px, 0px, 0px)"),this.refs.body.style[_transform2.default]="translate3d("+this._xNext+"px, "+this._yNext+"px, 0px)",this.refs.xScrollerNub.style[_transform2.default]="translate3d("+this._xScrollNubPosition+"px, 0px, 0px)",this.refs.yScrollerNub.style[_transform2.default]="translate3d(0px, "+this._yScrollNubPosition+"px, 0px)"}},{key:"handleMoveIntent",value:function(t){t.preventDefault(),0===t.deltaX&&0===t.deltaY||this._manuallyScrollingY&&0===t.deltaY||this._manuallyScrollingX&&0===t.deltaX||(this._xNext=this._manuallyScrollingY?0:this._xCurrent-t.deltaX,this._xNext>0?this._xNext=0:this._xNext<this._xMaximumTranslation&&(this._xNext=this._xMaximumTranslation),this._yNext=this._manuallyScrollingX?0:this._yCurrent-t.deltaY,this._yNext<this._yCurrent?this.handleScrollDown():this._yNext>this._yCurrent&&this.handleScrollUp(),this._yNext>0?this._yNext=0:this._yNext<this._yLowerBound&&(this._yNext=this._yLowerBound),this._xScrollNubPosition=Math.abs(this._xNext)/(this._rowWidth-this._containerWidth)*(this._xScrollerWidth-this.state.xScrollerNubSize),this._xScrollNubPosition+this.state.xScrollerNubSize>this._xScrollerWidth&&(this._xScrollNubPosition=this._xScrollerWidth-this.state.xScrollerNubSize),this._yScrollNubPosition=this._rowStartIndex/this.props.totalRows*this._containerHeight,this._yScrollNubPosition+this.state.yScrollerNubSize>this._containerHeight&&(this._yScrollNubPosition=this._containerHeight-this.state.yScrollerNubSize),this.performTranslations(),this._xCurrent=this._xNext,this._yCurrent=this._yNext,this._xCurrentScrollNubPosition=this._xScrollNubPosition,this._yCurrentScrollNubPosition=this._yScrollNubPosition)}},{key:"handleColumnResize",value:function(t){var e=this;if(0!==t){var i=t,r=0,n=this.state.columns.map(function(t){return t.mapping!==e._manuallyResizingColumn.mapping?(r+=t.width,t):(0>i&&!isNaN(e._minimumColumnWidth)&&t.width+i<e._minimumColumnWidth?i=e._minimumColumnWidth-t.width:!isNaN(e._maximumColumnWidth)&&t.width+i>e._maximumColumnWidth&&(i=e._maximumColumnWidth-t.width),r+=t.width+i,_extends({},t,{width:t.width+i}))});r<=this._containerWidth?this._xMaximumTranslation=0:this._xMaximumTranslation-=i,this.setState({columns:n,xScrollerNubSize:this.calculateXScrollerNubSize()},function(){e._rowWidth=e.refs.body.getElementsByClassName("ui-table-row")[0].clientWidth,0>i&&e.handleMoveIntent({deltaX:i,deltaY:0,preventDefault:_noop2.default})})}}},{key:"handleColumnDragStart",value:function(t){0===t.button&&(this._lastColumnX=t.clientX,this._manuallyResizingColumn=this.state.columns[t.target.getAttribute("data-column-index")],window.addEventListener("mouseup",this.handleDragEnd,!0),t.nativeEvent.preventDefault())}},{key:"handleXScrollerDragStart",value:function(t){0===t.button&&(this._lastXScroll=t.clientX,this._manuallyScrollingX=!0,window.addEventListener("mouseup",this.handleDragEnd,!0),t.nativeEvent.preventDefault())}},{key:"handleYScrollerDragStart",value:function(t){0===t.button&&(this._lastYScroll=t.clientY,this._manuallyScrollingY=!0,window.addEventListener("mouseup",this.handleDragEnd,!0),t.nativeEvent.preventDefault())}},{key:"handleDragMove",value:function(t){0===t.button&&(this._manuallyResizingColumn&&(this.handleColumnResize(t.clientX-this._lastColumnX),this._lastColumnX=t.clientX),this._manuallyScrollingX&&(this.handleMoveIntent({deltaX:t.clientX-this._lastXScroll,deltaY:0,preventDefault:_noop2.default}),this._lastXScroll=t.clientX),this._manuallyScrollingY&&(this.handleMoveIntent({deltaX:0,deltaY:(t.clientY-this._lastYScroll)/this._containerHeight*this.props.totalRows*this._cellHeight,preventDefault:_noop2.default}),this._lastYScroll=t.clientY))}},{key:"handleDragEnd",value:function(){window.removeEventListener("mouseup",this.handleDragEnd,!0),this._manuallyScrollingX=this._manuallyScrollingY=this._manuallyResizingColumn=!1}},{key:"handleRowClick",value:function(t,e){this.props.onRowInteract&&(t.persist(),this.props.onRowInteract(t,e)),this.setState({currentActiveRowIndex:findWhere(this.state.rows,"data",e).setIndex})}},{key:"renderRows",value:function(){var t=this;return this.state.rows.map(function(e,i){return _react2.default.createElement(_row2.default,{key:i,active:e.setIndex===t.state.currentActiveRowIndex,columns:t.state.columns,data:e.data,even:e.setIndex%2===0,y:e.y,onInteract:t.handleRowClick,onCellInteract:t.props.onCellInteract})})}},{key:"renderBody",value:function(){return _react2.default.createElement("div",{ref:"body",className:"ui-table-body"},this.renderRows())}},{key:"renderColumnResizeHandle",value:function(t,e){return t.resizable?_react2.default.createElement("div",{className:"ui-table-header-cell-resize-handle","data-column-index":e,onMouseDown:this.handleColumnDragStart}):void 0}},{key:"renderHead",value:function(){var t=this;return this.state.chokeRender?void 0:_react2.default.createElement("div",{ref:"head",className:"ui-table-header"},_react2.default.createElement("div",{className:"ui-table-row ui-table-header-row"},this.state.columns.map(function(e,i){return _react2.default.createElement("div",{key:i,className:"ui-table-cell ui-table-header-cell",style:{width:"number"==typeof e.width?e.width:null}},_react2.default.createElement("div",{className:"ui-table-cell-inner"},_react2.default.createElement("span",{className:"ui-table-cell-inner-text"},e.title)),t.renderColumnResizeHandle(e,i))})))}},{key:"renderScrollbars",value:function(){return _react2.default.createElement("div",null,_react2.default.createElement("div",{ref:"xScroller",className:"ui-table-x-scroller",onMouseDown:this.handleXScrollerDragStart},_react2.default.createElement("div",{ref:"xScrollerNub",className:"ui-table-x-scroller-nub",style:{width:this.state.xScrollerNubSize}})),_react2.default.createElement("div",{className:"ui-table-y-scroller",onMouseDown:this.handleYScrollerDragStart},_react2.default.createElement("div",{ref:"yScrollerNub",className:"ui-table-y-scroller-nub",style:{height:this.state.yScrollerNubSize}})))}},{key:"changeActiveRow",value:function(t){var e=this;this._nextActiveRow=findWhere(this.state.rows,"setIndex",this.state.currentActiveRowIndex+t),this._nextActiveRow?(this.setState({ariaSpokenOutput:this._nextActiveRow.data[this.state.columns[0].mapping],currentActiveRowIndex:this._nextActiveRow.setIndex}),(-1===t&&-1*this._nextActiveRow.y>this._yCurrent||1===t&&-1*this._nextActiveRow.y-this._cellHeight<this._yCurrent-this._containerHeight+this._cellHeight)&&this.handleMoveIntent({deltaX:0,deltaY:this._cellHeight*t,preventDefault:_noop2.default})):(-1===t&&this.state.currentActiveRowIndex>0||1===t&&this.state.currentActiveRowIndex<this.props.totalRows)&&(this.handleMoveIntent({deltaX:0,deltaY:(this._rowStartIndex>this.state.currentActiveRowIndex&&this.state.currentActiveRowIndex-this._rowStartIndex||(this._rowStartIndex<this.state.currentActiveRowIndex&&this.state.currentActiveRowIndex-this._rowStartIndex)+t)*this._cellHeight,preventDefault:_noop2.default}),window.requestAnimationFrame(function(){return e.changeActiveRow(t)})),this._nextActiveRow=null}},{key:"ariaExposeFullRowData",value:function(){var t=this;this._ariaExposeFullRowData=findWhere(this.state.rows,"setIndex",this.state.currentActiveRowIndex),this._ariaExposeFullRowData&&this.setState({ariaSpokenOutput:this.state.columns.map(function(e){return e.title+": "+t._ariaExposeFullRowData.data[e.mapping]}).join("\n")})}},{key:"handleKeyDown",value:function(t){switch(t.key){case"ArrowDown":this.changeActiveRow(1),t.preventDefault();break;case"ArrowUp":this.changeActiveRow(-1),t.preventDefault();break;case"Enter":this.ariaExposeFullRowData(),t.preventDefault()}"function"==typeof this.props.onKeyDown&&(t.persist(),this.props.onKeyDown(t))}},{key:"renderNotification",value:function(){return _react2.default.createElement("div",{ref:"aria",className:this.props.offscreenClass,"aria-live":"polite"},this.state.ariaSpokenOutput)}},{key:"render",value:function(){return _react2.default.createElement("div",_extends({},this.props,{ref:"wrapper",className:"ui-table-wrapper "+this.props.className,onKeyDown:this.handleKeyDown,onMouseMove:this.handleDragMove,onWheel:this.handleMoveIntent,tabIndex:"0"}),_react2.default.createElement("div",{ref:"table",className:"ui-table"},this.renderHead(),this.renderBody()),this.renderNotification(),this.renderScrollbars())}}]),e}(_UIView3.default);UITable.propTypes={columns:_react2.default.PropTypes.arrayOf(_react2.default.PropTypes.shape({mapping:_react2.default.PropTypes.string,resizable:_react2.default.PropTypes.bool,title:_react2.default.PropTypes.string,width:_react2.default.PropTypes.number})),getRow:_react2.default.PropTypes.func,offscreenClass:_react2.default.PropTypes.string,onCellInteract:_react2.default.PropTypes.func,onRowInteract:_react2.default.PropTypes.func,name:_react2.default.PropTypes.string,totalRows:_react2.default.PropTypes.number},UITable.defaultProps={className:"",columns:[],getRow:_noop2.default,offscreenClass:"ui-offscreen",totalRows:0},exports.default=UITable;