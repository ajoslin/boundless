"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();Object.defineProperty(exports,"__esModule",{value:!0});var _react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_UIDialog=require("../UIDialog"),_UIDialog2=_interopRequireDefault(_UIDialog),_UIView2=require("../UIView"),_UIView3=_interopRequireDefault(_UIView2),_transform=require("../UIUtils/transform"),_transform2=_interopRequireDefault(_transform),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),UIPopover=function(_UIView){function UIPopover(){return _classCallCheck(this,UIPopover),_possibleConstructorReturn(this,Object.getPrototypeOf(UIPopover).apply(this,arguments))}return _inherits(UIPopover,_UIView),_createClass(UIPopover,[{key:"initialState",value:function(){return{anchorXAlign:this.props.anchorXAlign,anchorYAlign:this.props.anchorYAlign,selfXAlign:this.props.selfXAlign,selfYAlign:this.props.selfYAlign}}},{key:"componentWillMount",value:function(){document.body.appendChild(this.container=document.createElement("div")),this.refs={},this.refs.dialog=this.renderDialog(),this.node=_reactDom2.default.findDOMNode(this.refs.dialog),this.align=this.align.bind(this),this.align(),window.addEventListener("resize",this.align,!0)}},{key:"componentDidUpdate",value:function(){this.renderDialog(),this.align()}},{key:"componentWillUnmount",value:function(){_reactDom2.default.unmountComponentAtNode(this.container),document.body.removeChild(this.container),window.removeEventListener("resize",this.align,!0)}},{key:"getNextXPosition",value:function(anchor,dialog){var state=this.state,position=UIPopover.position,nextX=anchor.getBoundingClientRect().left+document.body.scrollLeft;switch(state.anchorXAlign){case position.MIDDLE:nextX+=anchor.offsetWidth/2;break;case position.END:nextX+=anchor.offsetWidth}switch(state.selfXAlign){case position.MIDDLE:nextX-=dialog.clientWidth/2;break;case position.END:nextX-=dialog.clientWidth}return nextX}},{key:"getNextYPosition",value:function(anchor,dialog){var state=this.state,position=UIPopover.position,anchorY=anchor.getBoundingClientRect().top+document.body.scrollTop,anchorHeight=anchor.offsetHeight,nextY=anchorY+anchorHeight;switch(state.anchorYAlign){case position.START:nextY=anchorY;break;case position.MIDDLE:nextY=anchorY+anchorHeight/2}switch(state.selfYAlign){case position.MIDDLE:nextY-=dialog.clientHeight/2;break;case position.END:nextY-=dialog.clientHeight}return nextY}},{key:"getAlignmentCorrectionIfOverflowing",value:function(node,x,y){if(!this.props.autoReposition)return!1;var corrections={},width=node.clientWidth,height=node.clientHeight,xMax=document.body.scrollWidth,yMax=document.body.scrollHeight;return x+width>xMax?(corrections.anchorXAlign=UIPopover.position.END,corrections.selfXAlign=UIPopover.position.END):0>x?(corrections.anchorXAlign=UIPopover.position.START,corrections.selfXAlign=UIPopover.position.START):y+height>yMax?(corrections.anchorYAlign=UIPopover.position.START,corrections.selfYAlign=UIPopover.position.END):0>y&&(corrections.anchorYAlign=UIPopover.position.END,corrections.anchorXAlign=UIPopover.position.MIDDLE,corrections.selfYAlign=UIPopover.position.START,corrections.selfXAlign=UIPopover.position.MIDDLE),corrections}},{key:"applyTranslation",value:function(node,x,y){_transform2.default?node.style[_transform2.default]="translate("+x+"px, "+y+"px)":(node.style.left=x+"px",node.style.top=y+"px")}},{key:"align",value:function(){var _this2=this,anchor=this.props.anchor instanceof HTMLElement?this.props.anchor:_reactDom2.default.findDOMNode(this.props.anchor),x=this.getNextXPosition(anchor,this.node),y=this.getNextYPosition(anchor,this.node),alignmentCorrection=this.getAlignmentCorrectionIfOverflowing(this.node,x,y);return alignmentCorrection&&Object.keys(alignmentCorrection).length?this.setState(alignmentCorrection,function(){return _this2.componentDidUpdate()}):void this.applyTranslation(this.node,x,y)}},{key:"getClassAlignmentFragment",value:function(constant){var position=UIPopover.position;switch(constant){case position.START:return"start";case position.MIDDLE:return"middle";case position.END:return"end"}}},{key:"renderDialog",value:function(){var _cx,state=this.state,getFrag=this.getClassAlignmentFragment;return _reactDom2.default.render(_react2.default.createElement(_UIDialog2.default,_extends({},this.props,{captureFocus:!1,className:(0,_classnames2.default)((_cx={"ui-popover":!0},_defineProperty(_cx,"ui-popover-anchor-x-"+getFrag(state.anchorXAlign),!0),_defineProperty(_cx,"ui-popover-anchor-y-"+getFrag(state.anchorYAlign),!0),_defineProperty(_cx,"ui-popover-self-x-"+getFrag(state.selfXAlign),!0),_defineProperty(_cx,"ui-popover-self-y-"+getFrag(state.selfYAlign),!0),_defineProperty(_cx,this.props.className,!!this.props.className),_cx)),style:_extends({},this.props.style,{position:"absolute",top:"0px",left:"0px"})})),this.container)}},{key:"render",value:function(){return _react2.default.createElement("div",null)}}]),UIPopover}(_UIView3.default);UIPopover.position={START:"START",MIDDLE:"MIDDLE",END:"END"},UIPopover.propTypes=_extends({},_UIDialog2.default.propTypes,{anchor:_react2.default.PropTypes.oneOfType([_react2.default.PropTypes.instanceOf(HTMLElement),_react2.default.PropTypes.shape({props:_react2.default.PropTypes.object,state:_react2.default.PropTypes.object})]).isRequired,anchorXAlign:_react2.default.PropTypes.oneOf([UIPopover.position.START,UIPopover.position.MIDDLE,UIPopover.position.END]),anchorYAlign:_react2.default.PropTypes.oneOf([UIPopover.position.START,UIPopover.position.MIDDLE,UIPopover.position.END]),autoReposition:_react2.default.PropTypes.bool,selfXAlign:_react2.default.PropTypes.oneOf([UIPopover.position.START,UIPopover.position.MIDDLE,UIPopover.position.END]),selfYAlign:_react2.default.PropTypes.oneOf([UIPopover.position.START,UIPopover.position.MIDDLE,UIPopover.position.END])}),UIPopover.defaultProps=_extends({},_UIDialog2.default.defaultProps,{anchorXAlign:UIPopover.position.START,anchorYAlign:UIPopover.position.END,autoReposition:!0,selfXAlign:UIPopover.position.START,selfYAlign:UIPopover.position.START}),exports.default=UIPopover;