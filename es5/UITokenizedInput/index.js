"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();Object.defineProperty(exports,"__esModule",{value:!0});var _react=require("react"),_react2=_interopRequireDefault(_react),_UITypeaheadInput=require("../UITypeaheadInput"),_UITypeaheadInput2=_interopRequireDefault(_UITypeaheadInput),_UIView2=require("../UIView"),_UIView3=_interopRequireDefault(_UIView2),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),_noop=require("../UIUtils/noop"),_noop2=_interopRequireDefault(_noop),first=function(e){return e[0]},last=function(e){return e[e.length-1]},without=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;t>s;s++)n[s-1]=arguments[s];return e.filter(function(e){return-1===n.indexOf(e)})},UITokenizedInput=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"initialState",value:function(){return{tokenizedEntityIndexesSelected:[],tokenizedEntityIndexes:[].concat(this.props.defaultTokenizedEntityIndexes)}}},{key:"componentDidUpdate",value:function(e,t){var n=t.tokenizedEntityIndexes,s=t.tokenizedEntityIndexesSelected,i=this.state.tokenizedEntityIndexes,o=this.state.tokenizedEntityIndexesSelected;if(n!==i&&this.props.onTokenChange(i),s!==o){if(0===o.length)return;1===o.length||o[0]!==s[0]?this.refs["token_"+o[0]].focus():last(o)!==last(s)&&this.refs["token_"+last(o)].focus()}}},{key:"addToken",value:function(e,t,n){var s=this,i=(Array.isArray(e)?e:[e]).filter(function(e){return-1===s.state.tokenizedEntityIndexes.indexOf(e)});this.setState({tokenizedEntityIndexes:this.state.tokenizedEntityIndexes.concat(i)}),t&&this.refs.typeahead.focusInput(),n&&this.refs.typeahead.setValue("")}},{key:"removeToken",value:function(){var e=arguments.length<=0||void 0===arguments[0]?this.state.tokenizedEntityIndexesSelected:arguments[0],t=arguments[1],n=arguments[2],s=Array.isArray(e)?e:[e];this.setState({tokenizedEntityIndexes:without.apply(void 0,[this.state.tokenizedEntityIndexes].concat(_toConsumableArray(s))),tokenizedEntityIndexesSelected:without.apply(void 0,[this.state.tokenizedEntityIndexesSelected].concat(_toConsumableArray(s)))}),t&&this.refs.typeahead.focusInput(),n&&this.refs.typeahead.setValue("")}},{key:"handleInputFocus",value:function(e){this.setState({tokenizedEntityIndexesSelected:[]}),"function"==typeof this.props.inputProps.onFocus&&(e.persist(),this.props.inputProps.onFocus(e))}},{key:"selectPreviousToken",value:function(e){var t=this.state.tokenizedEntityIndexesSelected,n=this.state.tokenizedEntityIndexes;if(1!==t.length||first(t)!==first(n))if(0===t.length)this.setState({tokenizedEntityIndexesSelected:[last(n)]});else{var s=n[n.indexOf(first(t))-1];this.setState({tokenizedEntityIndexesSelected:e?[s].concat(t):[s]})}}},{key:"selectNextToken",value:function(e){var t=this.state.tokenizedEntityIndexesSelected,n=this.state.tokenizedEntityIndexes;if(0!==t.length)if(last(t)===last(n))this.setState({tokenizedEntityIndexesSelected:[]}),this.refs.typeahead.focusInput();else{var s=n[n.indexOf(last(t))+1];this.setState({tokenizedEntityIndexesSelected:e?t.concat(s):[s]})}}},{key:"handleKeyDown",value:function(e){switch(e.key){case"ArrowLeft":this.selectPreviousToken(e.shiftKey);break;case"ArrowRight":this.selectNextToken(e.shiftKey);break;case"Backspace":this.state.tokenizedEntityIndexesSelected.length&&(e.preventDefault(),this.removeToken(),this.refs.typeahead.focusInput())}"function"==typeof this.props.onKeyDown&&(e.persist(),this.props.onKeyDown(e))}},{key:"handleTokenCloseClick",value:function(e){this.removeToken(e)}},{key:"renderTokenClose",value:function(e){return this.props.showTokenClose?_react2.default.createElement("div",{className:"ui-tokenfield-token-close",onClick:this.handleTokenCloseClick.bind(this,e)}):void 0}},{key:"selectSingleToken",value:function(e){(-1===this.state.tokenizedEntityIndexesSelected.indexOf(e)||this.state.tokenizedEntityIndexesSelected.length>1)&&this.setState({tokenizedEntityIndexesSelected:[e]})}},{key:"handleTokenKeyDown",value:function(e,t){switch(t.key){case"Enter":case"Space":this.selectSingleToken(e)}}},{key:"renderTokens",value:function(){var e=this;return _react2.default.createElement("div",{className:"ui-tokenfield-tokens"},this.state.tokenizedEntityIndexes.map(function(t){return _react2.default.createElement("div",{ref:"token_"+t,key:t,className:(0,_classnames2.default)({"ui-tokenfield-token":!0,"ui-tokenfield-token-selected":-1!==e.state.tokenizedEntityIndexesSelected.indexOf(t)}),onClick:e.selectSingleToken.bind(e,t),onKeyDown:e.handleTokenKeyDown.bind(e,t),tabIndex:"0"},e.props.entities[t].text,e.renderTokenClose(t))}))}},{key:"render",value:function(){var e=this,t=Object.keys(_UITypeaheadInput2.default.propTypes).reduce(function(t,n){return t[n]=e.props[n],t},{});return _react2.default.createElement("div",_extends({},this.props,{ref:"wrapper",className:(0,_classnames2.default)(_defineProperty({"ui-tokenfield-wrapper":!0},this.props.className,!!this.props.className)),onKeyDown:this.handleKeyDown.bind(this)}),this.renderTokens(),_react2.default.createElement(_UITypeaheadInput2.default,_extends({},t,{ref:"typeahead",className:"ui-tokenfield",onEntitySelected:this.addToken.bind(this),onFocus:this.handleInputFocus.bind(this),clearPartialInputOnSelection:!0})))}}]),t}(_UIView3.default);UITokenizedInput.propTypes=_extends({},_UITypeaheadInput2.default.propTypes,{defaultTokenizedEntityIndexes:_react2.default.PropTypes.arrayOf(_react2.default.PropTypes.number),onTokenChange:_react2.default.PropTypes.func,showTokenClose:_react2.default.PropTypes.bool}),UITokenizedInput.defaultProps=_extends({},_UITypeaheadInput2.default.defaultProps,{defaultTokenizedEntityIndexes:[],onTokenChange:_noop2.default,showTokenClose:!0}),exports.default=UITokenizedInput;