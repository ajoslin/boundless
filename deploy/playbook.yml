---
- hosts: platform-uikit
  vars:
    user: uikit
    home_dir: /home/{{ user }}
    app_dir: "{{ home_dir }}/app"

  handlers:
    - name: Restart NGINX
      sudo: true
      service: name=nginx enabled=yes state=restarted

  tasks:
    - name: Install server dependencies
      sudo: yes
      pkgng: name={{ item }}
      with_items:
        - nginx
        - rsync

    - name: Install the NGINX config with vhost for uikit
      sudo: true
      template: src=nginx.conf dest=/usr/local/etc/nginx/nginx.conf mode="u=r,g=r"
      notify: Restart NGINX

    - name: Enable NGINX
      sudo: true
      lineinfile:
        dest=/etc/rc.conf
        line="nginx_enable=\"YES\""
        state=present
        insertafter=EOF

    - name: Start NGINX
      sudo: true
      service: name=nginx enabled=yes state=started

    - name: Create the uikit user
      sudo: true
      user: name={{ user }} shell=/sbin/nologin

    - name: Copy over the uikit source
      sudo: true
      synchronize: src=../site/dist/ dest={{ app_dir }}

    - name: Change owner of uikit source
      sudo: true
      file: path={{ app_dir }} owner={{ user }} recurse=yes
